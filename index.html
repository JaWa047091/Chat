<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Messages ðŸ˜Ž</title>
<style>
/* ...keep all your existing CSS unchanged... */
</style>

<!-- Firebase libraries -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="card">
<h2>Messages ðŸ˜Ž</h2>

<div id="auth">
    <div id="loginBox">
        <h3>Login</h3>
        <input id="loginUser" placeholder="Name">
        <input id="loginPass" placeholder="Password" type="password">
        <button onclick="login()">Login</button>
        <p class="muted">Don't have an account? <span onclick="showSignup()">Sign up here</span></p>
    </div>

    <div id="signupBox" style="display:none;">
        <h3>Signup</h3>
        <input id="signupUser" placeholder="Name">
        <input id="signupPass" placeholder="Password" type="password">
        <div style="display:flex; justify-content:center; align-items:center; gap:8px; width:80%; max-width:300px; margin:8px auto;">
            <input id="signupCode" placeholder="Code" maxlength="4" style="flex:1; padding:12px 16px; font-family:monospace; font-size:1rem; border:2px solid #30363d; border-radius:12px; background:#0d1117; color:#58a6ff;">
            <button type="button" onclick="generateCode()" style="flex:1; padding:12px 16px;">ðŸŽ²</button>
        </div>
        <button onclick="signup()">Sign Up</button>
        <p class="muted">Already have an account? <span onclick="showLogin()">Login here</span></p>
    </div>
</div>

<!-- ...chatUI and adminUI unchanged... -->

</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCCz9BRue1um1fYQXfBHcXhLZKnrLJp0hk",
  authDomain: "p2pchat-ca7b7.firebaseapp.com",
  databaseURL: "https://p2pchat-ca7b7-default-rtdb.firebaseio.com/",
  projectId: "p2pchat-ca7b7",
  storageBucket: "p2pchat-ca7b7.firebasestorage.app",
  messagingSenderId: "972268794831",
  appId: "1:972268794831:web:7f50c70bb79490dbf398ba"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let myCode, myName, chatRef = null;
const chatLog = document.getElementById('chat');
const adminMessages = document.getElementById('adminMessages');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');
const adminMsgInput = document.getElementById('adminMsg');
const adminSendBtn = document.getElementById('adminSendBtn');

// UI setup
document.getElementById('auth').style.display = 'block';
document.getElementById('chatUI').style.display = 'none';
document.getElementById('adminUI').style.display = 'none';

// Show login/signup forms
function showSignup(){ document.getElementById('loginBox').style.display='none'; document.getElementById('signupBox').style.display='block'; }
function showLogin(){ document.getElementById('signupBox').style.display='none'; document.getElementById('loginBox').style.display='block'; }

// Generate 4-digit code
function generateCode(){
    const codeInput = document.getElementById('signupCode');
    let attempts = 0;
    function tryGenerate() {
        attempts++;
        if(attempts>10){alert("Try again"); return;}
        const code = Math.floor(1000 + Math.random()*9000).toString();
        db.ref("codes/"+code).get().then(snap => {
            if(snap.exists()) tryGenerate(); else codeInput.value = code;
        });
    }
    tryGenerate();
}

// Signup using Firebase Auth
function signup(){
    const username = document.getElementById('signupUser').value.trim();
    const password = document.getElementById('signupPass').value.trim();
    const code = document.getElementById('signupCode').value.trim();
    if(!username || !password || !code){ alert("Fill all fields"); return; }
    if(code.length!==4){ alert("Code must be 4 digits"); return; }

    // check code uniqueness
    db.ref("codes/"+code).get().then(snap=>{
        if(snap.exists()){ alert("Code taken"); return; }

        // create Firebase Auth user using email hack (username@example.com)
        auth.createUserWithEmailAndPassword(username+"@chat.com", password)
        .then(userCredential=>{
            const uid = userCredential.user.uid;
            myName = username;
            myCode = code;

            // save code in DB
            db.ref("codes/"+code).set(uid);
            db.ref("users/"+uid).set({ username, code, isAdmin:(username.toLowerCase()==='jacob') });
            alert("Signed up! Now login.");
            showLogin();
        })
        .catch(err=>{ alert("Signup error: "+err.message); });
    });
}

// Login using Firebase Auth
function login(){
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    if(!username || !password){ alert("Enter username & password"); return; }

    auth.signInWithEmailAndPassword(username+"@chat.com", password)
    .then(userCredential=>{
        const uid = userCredential.user.uid;
        db.ref("users/"+uid).get().then(snap=>{
            if(!snap.exists()){ alert("User data missing"); return; }

            const data = snap.val();
            myCode = data.code;
            myName = data.username;
            document.getElementById('myCode').innerText = myCode;
            document.getElementById('auth').style.display='none';

            if(data.isAdmin){
                document.getElementById('chatUI').style.display='none';
                document.getElementById('adminUI').style.display='grid';
                document.getElementById('adminCode').innerText = myCode;
                loadAllUsers();
            } else {
                document.getElementById('chatUI').style.display='flex';
                document.getElementById('adminUI').style.display='none';
            }
        });
    })
    .catch(err=>{ alert("Login error: "+err.message); });
}

// The rest of your chat code (connectChat, sendMessage, log, admin functions) remains mostly unchanged...
</script>
</body>
</html>
