<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Messages ðŸ˜Ž</title>
<style>
    body {
        margin: 0; padding: 0;
        font-family: 'Segoe UI', sans-serif;
        height: 100vh; display: flex; justify-content: center; align-items: center;
        background: #0d1117; color: #fff;
    }
    .card {
        width: 95%; max-width: 1000px; height: 95%;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        background: #161b22; border-radius: 20px;
        box-shadow: 0 12px 30px rgba(0,255,255,0.2); padding: 20px; text-align: center;
    }
    input, textarea {
        width: 80%; max-width: 300px; padding: 12px 16px;
        border: 2px solid #30363d; border-radius: 12px; outline: none;
        font-family: monospace; font-size: 1rem; box-sizing: border-box;
        margin: 8px auto; display: block; background:#0d1117; color:#58a6ff;
        transition: border 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus { border-color:#58a6ff; box-shadow:0 0 8px rgba(88,166,255,0.5);}
    button {
        width: auto; padding: 12px 20px; border-radius:12px; border:none;
        background: linear-gradient(135deg,#58a6ff,#1f6feb);
        color:#fff; font-weight:bold; cursor:pointer; transition:background 0.3s;
    }
    button:hover { background: linear-gradient(135deg,#1f6feb,#58a6ff);}
    .muted {font-size:14px;color:#8b949e;}
    .muted span {color:#58a6ff; cursor:pointer;}
    .muted span:hover {text-decoration:underline;}
    #chatUI {display:none; flex:1; width:100%; max-width:600px; flex-direction:column; justify-content:flex-start; align-items:center;}
    .chat-box {background:#0d1117; border-radius:16px; padding:10px; flex:1; width:100%; display:flex; flex-direction:column; justify-content:flex-end; margin:15px 0; gap:6px; overflow-y:auto;}
    .message {margin:0; padding:8px 12px; border-radius:12px; max-width:80%; word-wrap:break-word; display:inline-block; font-weight:500;}
    .message.you {background:#238636;color:#fff; align-self:flex-end; text-align:right;}
    .message.friend {background:#a5d6ff;color:#0d1117; align-self:flex-start; text-align:left;}
    .message.system {background:#30363d;color:#8b949e; align-self:center; font-style:italic;}
    .timestamp{font-size:10px; opacity:0.6; margin-left:6px;}
    #msgContainer{display:flex; justify-content:center; gap:8px; margin-top:5px; width:100%;}
    #adminUI{display:none; width:100%; height:100%; display:grid; grid-template-columns:2fr 1fr; grid-template-rows:60px auto 1fr 60px; gap:10px; padding:10px;}
    #adminUI .header{grid-column:span 2; font-size:1.6rem; font-weight:bold; display:flex; justify-content:space-between; align-items:center; padding:0 10px; color:#58a6ff;}
    #adminInfo {grid-column:span 2; color:#58a6ff; margin-bottom:5px; font-size:1rem; font-weight:bold;}
    #adminUI .messages{background:#0d1117; border-radius:12px; padding:10px; display:flex; flex-direction:column; justify-content:flex-start; overflow:hidden; color:#fff;}
    #adminUI .users{background:#161b22; border-radius:12px; padding:10px; overflow:hidden; display:flex; flex-direction:column; color:#fff;}
    #adminUI table{width:100%; border-collapse:collapse; text-align:left;}
    #adminUI th,#adminUI td{border:1px solid #30363d; padding:4px 6px; font-size:0.9rem;}
    #adminUI th{background:#238636; color:#fff;}
    button.deleteBtn{background:#cf222e;color:#fff;cursor:pointer;border:none;padding:4px 8px;border-radius:6px;}
    button.deleteBtn:hover{background:#a40e26;}
    #adminUI .link-box a{color:#58a6ff; text-decoration:none; font-weight:bold;}
    #adminUI .link-box a:hover{text-decoration:underline;}
    #adminUI input, #adminUI button{width:80%; max-width:300px; margin:5px auto;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="card">
<h2>Messages ðŸ˜Ž</h2>

<!-- AUTH -->
<div id="auth">
    <div id="loginBox">
        <h3>Login</h3>
        <input id="loginUser" placeholder="Name">
        <input id="loginPass" placeholder="Password" type="password">
        <button onclick="login()">Login</button>
        <p class="muted">Don't have an account? <span onclick="showSignup()">Sign up here</span></p>
    </div>

    <div id="signupBox" style="display:none;">
        <h3>Signup</h3>
        <input id="signupUser" placeholder="Name">
        <input id="signupPass" placeholder="Password" type="password">
        <div style="display:flex; justify-content:center; align-items:center; gap:8px; width:80%; max-width:300px; margin:8px auto;">
            <input id="signupCode" placeholder="Code" maxlength="4" style="flex:1; padding:12px 16px; font-family:monospace; font-size:1rem; border:2px solid #30363d; border-radius:12px; background:#0d1117; color:#58a6ff;">
            <button type="button" onclick="generateCode()" style="flex:1; padding:12px 16px;">ðŸŽ²</button>
        </div>
        <button onclick="signup()">Sign Up</button>
        <p class="muted">Already have an account? <span onclick="showLogin()">Login here</span></p>
    </div>
</div>

<!-- NORMAL CHAT -->
<div id="chatUI">
    <p>Your code: <b id="myCode"></b></p>
    <input id="friendCode" placeholder="Enter friend's code">
    <button onclick="connectChat()">Connect</button>
    <div id="chat" class="chat-box"></div>
    <div id="msgContainer">
        <input id="msg" placeholder="Type your message here..." disabled>
        <button id="sendBtn" disabled>Send</button>
    </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminUI">
    <div class="header">
        <span>ðŸ”¥ Admin Panel ðŸ”¥</span>
        <span class="link-box">
            <a href="https://console.firebase.google.com/project/p2pchat-ca7b7/database/p2pchat-ca7b7-default-rtdb/data/~2F" target="_blank">Access all user data</a>
        </span>
    </div>

    <div id="adminInfo">Admin Code: <b id="adminCode">Loading...</b></div>

    <div class="messages" id="adminMessages"></div>
    <div class="users">
        <h3>All Users</h3>
        <table id="usersTable">
            <thead><tr><th>Username</th><th>Password</th><th>Action</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <input id="friendCodeAdmin" placeholder="Enter user's code">
    <button onclick="connectChat(true)">Connect</button>
    <div id="adminMsgContainer">
        <input id="adminMsg" placeholder="Type your message here..." disabled>
        <button id="adminSendBtn" disabled>Send</button>
    </div>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCCz9BRue1um1fYQXfBHcXhLZKnrLJp0hk",
  authDomain: "p2pchat-ca7b7.firebaseapp.com",
  databaseURL: "https://p2pchat-ca7b7-default-rtdb.firebaseio.com/",
  projectId: "p2pchat-ca7b7",
  storageBucket: "p2pchat-ca7b7.firebasestorage.app",
  messagingSenderId: "972268794831",
  appId: "1:972268794831:web:7f50c70bb79490dbf398ba"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myCode, myName, chatRef = null;
const chatLog = document.getElementById('chat');
const adminMessages = document.getElementById('adminMessages');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('sendBtn');
const adminMsgInput = document.getElementById('adminMsg');
const adminSendBtn = document.getElementById('adminSendBtn');

document.getElementById('auth').style.display = 'block';
document.getElementById('chatUI').style.display = 'none';
document.getElementById('adminUI').style.display = 'none';

function showSignup() {
  document.getElementById('loginBox').style.display = 'none';
  document.getElementById('signupBox').style.display = 'block';
}
function showLogin() {
  document.getElementById('signupBox').style.display = 'none';
  document.getElementById('loginBox').style.display = 'block';
}

function generateCode() {
  const codeInput = document.getElementById('signupCode');
  let attempts = 0;
  function tryGenerate() {
    attempts++;
    if (attempts > 10) { alert("Try again"); return; }
    const code = Math.floor(1000 + Math.random() * 9000).toString();
    db.ref("codes/" + code).get().then(snap => {
      if (snap.exists()) { tryGenerate(); } else { codeInput.value = code; }
    });
  }
  tryGenerate();
}

function signup() {
  const u = document.getElementById('signupUser').value.trim();
  const p = document.getElementById('signupPass').value.trim();
  let c = document.getElementById('signupCode').value.trim();
  if (!u || !p || !c) { alert("Fill all fields"); return; }
  if (c.length !== 4) { alert("Code must be 4 digits"); return; }

  db.ref("users/" + u).get().then(snap => {
    if (snap.exists()) { alert("Username taken"); return; }
    db.ref("codes/" + c).get().then(s => {
      if (s.exists()) { alert("Code taken"); return; }
      db.ref("users/" + u).set({ password: p, code: c, isAdmin: (u.toLowerCase() === 'jacob') });
      db.ref("codes/" + c).set(u);
      alert("Signed up! Now login.");
      showLogin();
    });
  });
}

function login() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  db.ref("users/" + u).get().then(snap => {
    if (!snap.exists() || snap.val().password !== p) { alert("Invalid login"); return; }
    myCode = snap.val().code;
    myName = u;
    document.getElementById('myCode').innerText = myCode;
    document.getElementById('auth').style.display = 'none';

    if (snap.val().isAdmin) {
      document.getElementById('chatUI').style.display = 'none';
      document.getElementById('adminUI').style.display = 'grid';
      loadAllUsers();
      document.getElementById('adminCode').innerText = snap.val().code;
    } else {
      document.getElementById('chatUI').style.display = 'flex';
      document.getElementById('adminUI').style.display = 'none';
    }
  });
}

function loadAllUsers() {
  db.ref("users").get().then(snapshot => {
    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = '';
    snapshot.forEach(child => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${child.key}</td><td>${child.val().password}</td><td><button class="deleteBtn" onclick="deleteUser('${child.key}')">Delete</button></td>`;
      tbody.appendChild(tr);
    });
  });
}

function deleteUser(username) {
  if (username.toLowerCase() === 'jacob') { alert("Can't delete admin!"); return; }
  if (confirm(`Delete ${username}?`)) {
    db.ref("users/" + username).remove();
    loadAllUsers();
  }
}

function getUsernameByCode(code) {
  return db.ref("codes/" + code).get().then(snap => snap.exists() ? snap.val() : "Unknown");
}

function connectChat(isAdmin = false) {
  const friendCode = isAdmin
    ? document.getElementById('friendCodeAdmin').value.trim()
    : document.getElementById('friendCode').value.trim();

  if (!friendCode) { alert("Enter a friend's code"); return; }

  const codeA = myCode;
  const codeB = friendCode;
  const chatID = [codeA, codeB].sort().join("_");

  chatRef = db.ref("messages/" + chatID);
  chatRef.off();
  chatRef.on("child_added", async snap => {
    const data = snap.val();
    if (data.sender !== codeA) {
      const senderName = (data.sender === 'ADMIN') ? 'Admin' : await getUsernameByCode(data.sender);
      log(data.msg, 'friend', senderName);
    }
  });

  if (isAdmin) {
    adminMsgInput.disabled = false;
    adminSendBtn.disabled = false;
  } else {
    msgInput.disabled = false;
    sendBtn.disabled = false;
  }

  log("Connected to " + friendCode, 'system');
}

function log(text, who = 'friend', senderName = 'Friend') {
  const div = document.createElement('div');
  if (who === 'you') div.className = 'message you';
  else if (who === 'system') div.className = 'message system';
  else div.className = 'message friend';

  const time = new Date();
  let label = (who === 'you') ? myName : (who === 'system') ? 'System' : senderName;
  div.innerHTML = `<b>${label}:</b> ${text} <span class="timestamp">${time.getHours()}:${time.getMinutes().toString().padStart(2, '0')}</span>`;

  chatLog.appendChild(div);
  adminMessages.appendChild(div.cloneNode(true));

  if (chatLog.children.length > 4) chatLog.removeChild(chatLog.firstChild);
  if (adminMessages.children.length > 4) adminMessages.removeChild(adminMessages.firstChild);

  chatLog.scroll({ top: chatLog.scrollHeight, behavior: 'smooth' });
  adminMessages.scroll({ top: adminMessages.scrollHeight, behavior: 'smooth' });
}

function sendMessage(isAdmin = false) {
  const input = isAdmin ? adminMsgInput : msgInput;
  if (!input.value || !chatRef) return;
  chatRef.push({ sender: isAdmin ? 'ADMIN' : myCode, msg: input.value });
  log(input.value, 'you');
  input.value = '';
}

msgInput.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });
sendBtn.onclick = () => sendMessage();
adminMsgInput.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); sendMessage(true); } });
adminSendBtn.onclick = () => sendMessage(true);
</script>
</body>
</html>
