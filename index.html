<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat ðŸ˜Ž</title>
<style>
body {margin:0; padding:0; font-family: 'Segoe UI', sans-serif; background:#0d1117; color:#fff; display:flex; justify-content:center; align-items:center; height:100vh;}
.card {width:90%; max-width:500px; padding:20px; background:#161b22; border-radius:16px; text-align:center;}
input {width:80%; padding:10px; margin:5px auto; border-radius:8px; border:none; background:#0d1117; color:#58a6ff;}
button {padding:8px 12px; margin:5px; border:none; border-radius:8px; background:linear-gradient(135deg,#58a6ff,#1f6feb); color:#fff; cursor:pointer;}
button:hover {background:linear-gradient(135deg,#1f6feb,#58a6ff);}
#chat {height:200px; background:#0d1117; margin:10px 0; padding:10px; overflow:auto; border-radius:8px;}
.message {margin:4px 0; padding:4px 8px; border-radius:6px; word-wrap:break-word;}
.message.you {background:#238636;}
.message.friend {background:#a5d6ff; color:#0d1117;}
.muted {font-size:14px; color:#8b949e;}
.muted span {color:#58a6ff; cursor:pointer;}
.muted span:hover {text-decoration:underline;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="card">
  <h2>P2P Chat ðŸ˜Ž</h2>

  <!-- Auth -->
  <div id="auth">
    <div id="loginBox">
      <input id="loginUser" placeholder="Username">
      <input id="loginPass" type="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <p class="muted">Don't have an account? <span onclick="showSignup()">Sign up here</span></p>
    </div>
    <div id="signupBox" style="display:none;">
      <input id="signupUser" placeholder="Username">
      <input id="signupPass" type="password" placeholder="Password">
      <input id="signupCode" maxlength="4" placeholder="Code (4 digits)">
      <button onclick="signup()">Sign Up</button>
      <p class="muted">Already have an account? <span onclick="showLogin()">Login here</span></p>
    </div>
  </div>

  <!-- Chat -->
  <div id="chatUI" style="display:none;">
    <p>Your code: <b id="myCode"></b></p>
    <input id="friendCode" placeholder="Enter friend's code">
    <button onclick="connectChat()">Connect</button>
    <div id="chat"></div>
    <input id="msg" placeholder="Type your message..." disabled>
    <button id="sendBtn" disabled onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const firebaseConfig = {
    apiKey: "AIzaSyCCz9BRue1um1fYQXfBHcXhLZKnrLJp0hk",
    authDomain: "p2pchat-ca7b7.firebaseapp.com",
    databaseURL: "https://p2pchat-ca7b7-default-rtdb.firebaseio.com",
    projectId: "p2pchat-ca7b7",
    storageBucket: "p2pchat-ca7b7.appspot.com",
    messagingSenderId: "972268794831",
    appId: "1:972268794831:web:7f50c70bb79490dbf398ba"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let myCode, myName, chatRef = null;
  const chatBox = document.getElementById('chat');
  const msgInput = document.getElementById('msg');
  const sendBtn = document.getElementById('sendBtn');

  // UI toggle
  window.showSignup = () => {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('signupBox').style.display = 'block';
  }
  window.showLogin = () => {
    document.getElementById('signupBox').style.display = 'none';
    document.getElementById('loginBox').style.display = 'block';
  }

  // Signup
  window.signup = () => {
    const u = document.getElementById('signupUser').value.trim();
    const p = document.getElementById('signupPass').value.trim();
    const c = document.getElementById('signupCode').value.trim();
    if(!u || !p || !c) { alert("Fill all fields"); return; }
    if(c.length !== 4) { alert("Code must be 4 digits"); return; }

    db.ref("users/"+u).get().then(snap => {
      if(snap.exists()) { alert("Username taken"); return; }
      db.ref("codes/"+c).get().then(codeSnap => {
        if(codeSnap.exists()) { alert("Code taken"); return; }
        db.ref("users/"+u).set({password:p, code:c});
        db.ref("codes/"+c).set(u);
        alert("Signup complete! Please login.");
        showLogin();
      });
    });
  }

  // Login
  window.login = () => {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    if(!u || !p) { alert("Enter username and password"); return; }

    db.ref("users/"+u).get().then(snap => {
      if(!snap.exists() || snap.val().password !== p) { alert("Invalid login"); return; }
      myCode = snap.val().code; myName = u;
      document.getElementById('myCode').innerText = myCode;
      document.getElementById('auth').style.display = 'none';
      document.getElementById('chatUI').style.display = 'block';
    });
  }

  // Connect chat
  window.connectChat = () => {
    const friendCode = document.getElementById('friendCode').value.trim();
    if(!friendCode) { alert("Enter friend's code"); return; }
    const chatID = [myCode, friendCode].sort().join("_");
    chatRef = db.ref("messages/"+chatID);
    chatRef.off();
    chatRef.on("child_added", snap => {
      const data = snap.val();
      const div = document.createElement('div');
      div.className = data.sender === myCode ? 'message you' : 'message friend';
      div.innerText = `${data.sender}: ${data.msg}`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
    msgInput.disabled = false;
    sendBtn.disabled = false;
    alert("Connected to "+friendCode);
  }

  // Send message
  window.sendMessage = () => {
    if(!msgInput.value || !chatRef) return;
    chatRef.push({sender: myCode, msg: msgInput.value});
    msgInput.value = '';
  }

  // Press Enter to send
  msgInput.addEventListener("keydown", e => {
    if(e.key==="Enter") { e.preventDefault(); sendMessage(); }
  });

});
</script>
</body>
</html>
